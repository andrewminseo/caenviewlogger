<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Monitor - CAENView</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            background-color: #00274c;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .content {
            display: flex;
            flex: 1;
        }
        .main-view {
            flex: 3;
            height: 100%;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .sidebar {
            flex: 1;
            background-color: #f5f5f5;
            padding: 15px;
            overflow-y: auto;
            max-width: 300px;
            border-left: 1px solid #ddd;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid #00274c;
            font-size: 0.9rem;
        }
        .alert {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
        }
        .alert-bell {
            animation: pulse 1.5s infinite;
            color: #f44336;
        }
        .refresh-status {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
        }
        .button {
            padding: 8px 12px;
            background-color: #ffcb05;
            color: #00274c;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .button:hover {
            background-color: #e6b800;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #4caf50;
        }
        .status-issue {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Classroom Monitor - CAENView</h1>
            <div class="controls">
                <span id="status-display">
                    <span class="status-indicator status-online"></span> Monitoring Active
                </span>
                <button id="refresh-btn" class="button">Manual Refresh</button>
                <button id="toggle-log" class="button">Toggle Log</button>
                <button id="clear-log" class="button">Clear Log</button>
                <span id="alert-indicator" style="display: none;">
                    <img src="/api/placeholder/24/24" alt="Alarm" id="alarm-icon" style="display: none;">
                    <i class="alert-bell" id="alert-bell">⚠️</i>
                </span>
            </div>
        </div>
        <div class="content">
            <div class="main-view">
                <iframe id="caenview-iframe" src="https://caenview.engin.umich.edu/" title="CAENView"></iframe>
            </div>
            <div class="sidebar" id="log-sidebar">
                <h2>Activity Log</h2>
                <div class="refresh-status" id="refresh-status">Last refresh: Never</div>
                <div id="log-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const REFRESH_INTERVAL = 60000; // 1 minute in milliseconds
        const MAX_LOG_ENTRIES = 100;
        let logVisible = true;
        let alertActive = false;
        let monitoringActive = true;
        let refreshTimer;
        let lastSnapshot = {};

        // DOM Elements
        const iframe = document.getElementById('caenview-iframe');
        const logContainer = document.getElementById('log-container');
        const refreshStatus = document.getElementById('refresh-status');
        const refreshBtn = document.getElementById('refresh-btn');
        const toggleLogBtn = document.getElementById('toggle-log');
        const clearLogBtn = document.getElementById('clear-log');
        const logSidebar = document.getElementById('log-sidebar');
        const alertIndicator = document.getElementById('alert-indicator');
        const alertBell = document.getElementById('alert-bell');
        const statusDisplay = document.getElementById('status-display');
        const statusIndicator = statusDisplay.querySelector('.status-indicator');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMonitoring();
            addLogEntry('Monitoring system initialized', 'info');
            refreshIframe();
            startAutoRefresh();
        });

        // Event Listeners
        refreshBtn.addEventListener('click', () => {
            refreshIframe();
            addLogEntry('Manual refresh triggered', 'info');
        });

        toggleLogBtn.addEventListener('click', () => {
            logVisible = !logVisible;
            logSidebar.style.display = logVisible ? 'block' : 'none';
            toggleLogBtn.textContent = logVisible ? 'Hide Log' : 'Show Log';
        });

        clearLogBtn.addEventListener('click', () => {
            clearLog();
            addLogEntry('Log cleared', 'info');
        });

        // Functions
        function initMonitoring() {
            // Set up message event listener to capture communication from iframe
            window.addEventListener('message', (event) => {
                if (event.origin === 'https://caenview.engin.umich.edu') {
                    processIframeMessage(event.data);
                }
            });
        }

        function startAutoRefresh() {
            // Clear any existing timers
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // Set up new timer
            refreshTimer = setInterval(() => {
                if (monitoringActive) {
                    refreshIframe();
                    addLogEntry('Auto-refresh performed', 'info');
                }
            }, REFRESH_INTERVAL);
            
            addLogEntry(`Auto-refresh started (every ${REFRESH_INTERVAL/1000} seconds)`, 'info');
        }

        function refreshIframe() {
            // Force iframe to reload
            iframe.src = iframe.src;
            updateRefreshStatus();
        }

        function updateRefreshStatus() {
            const now = new Date();
            refreshStatus.textContent = `Last refresh: ${now.toLocaleTimeString()}`;
        }

        function checkForAlerts(contentSnapshot) {
            // This is a simplified example - in a real implementation,
            // you would compare the current state with the previous state
            // to identify changes or issues
            
            // For demonstration, we'll simulate classroom alerts
            // based on randomly finding keywords in the content
            const simulateAlert = Math.random() < 0.3; // 30% chance of an alert for demo purposes
            
            if (simulateAlert) {
                setAlertState(true, 'Potential issue detected');
                return true;
            }
            
            return false;
        }

        function processIframeMessage(data) {
            // In a real implementation, we would receive and process messages
            // from the iframe (if the target site is set up to send them)
            addLogEntry(`Received update from CAENView`, 'info');
        }

        function captureSnapshot() {
            // In practice, this would capture the current state of classrooms
            // from the iframe content, but as we can't directly access iframe content
            // from another domain due to security restrictions, this is for demonstration
            
            try {
                // This is a simulated snapshot
                const snapshot = {
                    timestamp: new Date().toISOString(),
                    classroomsActive: Math.floor(Math.random() * 20) + 10,
                    classroomsWithIssues: Math.floor(Math.random() * 5)
                };
                
                if (snapshot.classroomsWithIssues > 0) {
                    setAlertState(true, `${snapshot.classroomsWithIssues} classrooms need attention`);
                } else {
                    setAlertState(false);
                }
                
                // Compare with last snapshot and log differences
                if (lastSnapshot.classroomsActive !== snapshot.classroomsActive) {
                    addLogEntry(`Active classrooms changed: ${lastSnapshot.classroomsActive || 0} → ${snapshot.classroomsActive}`, 'info');
                }
                
                if (lastSnapshot.classroomsWithIssues !== snapshot.classroomsWithIssues) {
                    if (snapshot.classroomsWithIssues > 0) {
                        addLogEntry(`${snapshot.classroomsWithIssues} classrooms need attention`, 'alert');
                    } else if (lastSnapshot.classroomsWithIssues > 0) {
                        addLogEntry(`All classroom issues resolved`, 'info');
                    }
                }
                
                lastSnapshot = snapshot;
                
            } catch (error) {
                addLogEntry(`Error capturing snapshot: ${error.message}`, 'error');
            }
        }

        function setAlertState(active, message = null) {
            alertActive = active;
            alertIndicator.style.display = active ? 'inline-block' : 'none';
            
            if (active && message) {
                addLogEntry(message, 'alert');
                statusIndicator.className = 'status-indicator status-issue';
                statusDisplay.querySelector('span:not(.status-indicator)').textContent = 'Alert Detected';
            } else if (!active) {
                statusIndicator.className = 'status-indicator status-online';
                statusDisplay.querySelector('span:not(.status-indicator)').textContent = 'Monitoring Active';
            }
        }

        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<strong>${timestamp}</strong> - ${message}`;
            
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Limit log entries
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > MAX_LOG_ENTRIES) {
                for (let i = MAX_LOG_ENTRIES; i < entries.length; i++) {
                    logContainer.removeChild(entries[i]);
                }
            }
        }

        function clearLog() {
            logContainer.innerHTML = '';
        }

        // Set up periodic snapshot capture
        setInterval(() => {
            if (monitoringActive) {
                captureSnapshot();
            }
        }, 10000); // Capture snapshot every 10 seconds
    </script>
</body>
</html>
